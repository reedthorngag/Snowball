
services:

  db:
    image: mongo:latest
    attach: false
    #environment:
      #MONGO_INITDB_ROOT_USERNAME: ${DB_ADMIN_USER}
      #MONGO_INITDB_ROOT_PASSWORD: ${DB_ADMIN_PASSWORD}
    volumes:
      - db-data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:${DB_PORT}/${DB_PATH} --quiet
      interval: 1s
      timeout: 10s
      start_period: 10s
      start_interval: 1s
      retries: 10

  backend:
    build:
      context: .
      dockerfile: ./Dockerfile
      target: base
    volumes:
      #- ./backend/node_modules:/app/backend/node_modules
      - ./backend/src:/app/backend/src
      - ./frontend/src:/app/frontend/src
    environment:
      TSC_NONPOLLING_WATCHER: "0"
      DB_URI: mongodb://${DB_HOST}:${DB_PORT}/${DB_PATH}
      ENV: ${ENV}
      API_VERSION: ${API_VERSION}
      CLIENT_ID: ${CLIENT_ID}
      CLIENT_SECRET: ${CLIENT_SECRET}
      SCOPE: ${SCOPE}
      GOOGLE_AUTH_URL: ${GOOGLE_AUTH_URL}
      AUTH_CALLBACK_URL: ${AUTH_CALLBACK_URL}
    depends_on:
      db:
        condition: service_healthy
    links:
      - db:database
    ports:
      - 443:443
      - 80:80
    command: sh -c "npm run ${ENV}"

volumes:
  db-data:
